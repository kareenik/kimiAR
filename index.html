<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofa Configurator | E-commerce Preview</title>
    <!-- Import the model-viewer component -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --sofa-black: #111111;
            --unit: 12px;
            --gap: 2px;
        }
        body {
            margin: 0;
            background-color: #1a1a1a;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95vw;
            height: 90vh;
            max-width: 1200px;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .viewer-pane {
            flex: 1;
            background-color: #f8f9fa;
            position: relative;
        }

        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
        }

        .sidebar-pane {
            width: 380px;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            background: white;
            z-index: 10;
        }

        @keyframes pulse-ar {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .ar-button {
            animation: pulse-ar 2s infinite;
        }

        .icon-canvas {
            display: grid;
            grid-gap: var(--gap);
            justify-content: center;
            align-content: center;
        }
        .sofa-module {
            background-color: var(--sofa-black);
            border-radius: 3px;
        }
        .active-layout {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }

        @media (max-width: 768px) {
            .modal-container {
                flex-direction: column;
                height: 100vh;
                width: 100vw;
                top: 0;
                left: 0;
                transform: none;
                border-radius: 0;
            }
            .sidebar-pane { width: 100%; height: 50%; }
            .viewer-pane { height: 50%; }
        }
    </style>
</head>
<body>

    <div class="modal-container">
        <!-- LEFT: Viewing Area -->
        <div class="viewer-pane">
            <model-viewer 
                id="viewer" 
                camera-controls 
                touch-action="pan-y" 
                src="https://kareenik.github.io/kimiAR/models/S77/S77-1CL2SDR-variants.glb" 
                ar 
                ar-modes="webxr scene-viewer quick-look"
                shadow-intensity="1" 
                exposure="1"
                environment-image="neutral"
                alt="S77 Modular Sofa">
                
                <div id="progress-container" class="absolute top-0 left-0 w-full h-1 bg-gray-100 hidden z-20">
                    <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Floating Toolset -->
                <div class="absolute bottom-6 left-6 flex flex-col gap-3">
                    <button id="reset-view" class="p-3 bg-white rounded-full shadow-lg hover:bg-gray-50 transition-colors" title="Reset View">
                        <i data-lucide="rotate-ccw" class="w-5 h-5 text-gray-600"></i>
                    </button>
                </div>
            </model-viewer>
        </div>

        <!-- RIGHT: Sidebar Configuration -->
        <div class="sidebar-pane">
            <!-- Header -->
            <div class="p-6 border-b border-gray-100">
                <div class="flex justify-between items-start mb-1">
                    <h1 class="text-2xl font-bold text-gray-900 leading-tight">S77 Modular</h1>
                    <button class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-500 font-medium tracking-tight">Technical Fabric Edition</p>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- Layout Selection -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider text-gray-900">1. Layout</h2>
                        <span id="current-layout-label" class="text-xs text-blue-600 font-semibold bg-blue-50 px-2 py-0.5 rounded">S77-1CL2SDR</span>
                    </div>
                    <div id="layout-grid" class="grid grid-cols-4 gap-3">
                        <!-- Icons generated via JS -->
                    </div>
                </section>

                <!-- Fabric Selection -->
                <section>
                    <h2 class="text-sm font-bold uppercase tracking-wider text-gray-900 mb-4">2. Fabric</h2>
                    <div class="relative">
                        <select id="variant-select" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3 pl-4 pr-10 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-gray-800 text-sm font-medium">
                            <option value="default">Loading fabrics...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Main CTA Footer -->
            <div class="p-6 border-t border-gray-100 bg-gray-50/50">
                <div class="flex items-center justify-between mb-4">
                    <span id="status-text" class="text-xs text-gray-400 italic">Select a layout to update view</span>
                    <label for="file-upload" class="cursor-pointer text-gray-400 hover:text-blue-600 transition-colors">
                        <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                    </label>
                    <input id="file-upload" type="file" accept=".gltf,.glb" class="hidden">
                </div>
                <button onclick="document.getElementById('viewer').activateAR()" class="ar-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98]">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                    Vaata liitreaalsuses (AR)
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const modelViewer = document.querySelector("#viewer");
        const select = document.querySelector('#variant-select');
        const progressBar = document.querySelector('#progress-bar');
        const statusText = document.querySelector('#status-text');
        const layoutLabel = document.querySelector('#current-layout-label');
        
        const baseUrl = "https://kareenik.github.io/kimiAR/models/S77/";

        // --- Model Mapping ---
        const layoutDefinitions = [
            { id: 'S77-1CL2SDR', file: 'S77-1CL2SDR-variants.glb', modules: [{ type: 'CL', x: 0, y: 0, w: 1, h: 2 }, { type: 'D', x: 1, y: 0, w: 1, h: 1 }, { type: 'SDR', x: 2, y: 0, w: 1, h: 2 }] },
            { id: 'S77-12CL2SDR', file: 'S77-12CL2SDR-variants.glb', modules: [{ type: 'CL', x: 0, y: 0, w: 1, h: 2 }, { type: '2D', x: 1, y: 0, w: 2, h: 1 }, { type: 'SDR', x: 3, y: 0, w: 1, h: 2 }] },
            { id: 'S77-1D2', file: 'S77-1D2-variants.glb', modules: [{ type: '2D', x: 0, y: 0, w: 2, h: 1 }] },
            { id: 'S77-21D', file: 'S77-21D-variants.glb', modules: [{ type: 'D', x: 0, y: 0, w: 1, h: 1 }, { type: 'D', x: 1, y: 0, w: 1, h: 1 }] },
            { id: 'S77-2D2CR', file: 'S77-2D2CR-variants.glb', modules: [{ type: '2D', x: 0, y: 0, w: 2, h: 1 }, { type: 'CR', x: 2, y: 0, w: 1, h: 2 }] },
            { id: 'S77-2SDL1CR', file: 'S77-2SDL1CR-variants.glb', modules: [{ type: 'SDL', x: 0, y: 0, w: 3, h: 1 }, { type: 'CR', x: 3, y: 0, w: 1, h: 2 }] },
            { id: 'S77-2SDL2CR1', file: 'S77-2SDL2CR1-variants.glb', modules: [{ type: 'CR', x: 0, y: 0, w: 1, h: 2 }, { type: 'SDL', x: 1, y: 0, w: 3, h: 1 }] },
            { id: 'S77-P1', file: 'S77-P1-variants.glb', modules: [{ type: 'P1', x: 0, y: 0, w: 1, h: 1 }] },
            { id: 'S77-KT1', file: 'S77-KT1-variants.glb', modules: [{ type: 'P1', x: 0, y: 0, w: 1, h: 1 }] }, // Coffee table as circle
            { id: 'S77-1F', file: 'S77-1F-variants.glb', modules: [{ type: 'D', x: 0, y: 0, w: 1.5, h: 1 }] }
        ];

        function createSofaIcon(definition) {
            const container = document.createElement('div');
            container.className = 'icon-canvas w-8 h-8';
            const maxX = Math.max(...definition.modules.map(m => m.x + m.w));
            const maxY = Math.max(...definition.modules.map(m => m.y + m.h));
            container.style.gridTemplateColumns = `repeat(${Math.ceil(maxX * 2)}, calc(var(--unit)/2))`;
            container.style.gridTemplateRows = `repeat(${Math.ceil(maxY * 2)}, calc(var(--unit)/2))`;

            definition.modules.forEach(m => {
                const block = document.createElement('div');
                block.className = 'sofa-module';
                block.style.gridColumn = `${Math.round(m.x * 2) + 1} / span ${Math.round(m.w * 2)}`;
                block.style.gridRow = `${Math.round(m.y * 2) + 1} / span ${Math.round(m.h * 2)}`;
                if(m.id === 'S77-KT1' || m.type === 'P1') block.style.borderRadius = '50%';
                container.appendChild(block);
            });
            return container;
        }

        const layoutGrid = document.getElementById('layout-grid');
        layoutDefinitions.forEach((layout, idx) => {
            const btn = document.createElement('button');
            btn.className = `aspect-square rounded-xl border-2 border-gray-100 hover:border-blue-200 transition-all flex items-center justify-center p-2 focus:outline-none ${idx === 0 ? 'active-layout' : ''}`;
            btn.appendChild(createSofaIcon(layout));
            
            btn.addEventListener('click', () => {
                document.querySelectorAll('#layout-grid button').forEach(b => b.classList.remove('active-layout'));
                btn.classList.add('active-layout');
                layoutLabel.textContent = layout.id;
                statusText.textContent = `Loading ${layout.id}...`;
                modelViewer.src = baseUrl + layout.file;
            });
            layoutGrid.appendChild(btn);
        });

        // --- Core Logic ---
        modelViewer.addEventListener('progress', (e) => {
            const progress = e.detail.totalProgress * 100;
            document.getElementById('progress-container').classList.remove('hidden');
            progressBar.style.width = `${progress}%`;
            if(progress >= 100) setTimeout(() => document.getElementById('progress-container').classList.add('hidden'), 500);
        });

        modelViewer.addEventListener('load', () => {
            statusText.textContent = "Model Loaded";
            const names = modelViewer.availableVariants;
            select.innerHTML = names.length > 0 ? '' : '<option value="default">No fabric variants</option>';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        });

        select.addEventListener('input', (e) => {
            modelViewer.variantName = e.target.value;
        });

        document.getElementById('reset-view').addEventListener('click', () => {
            modelViewer.cameraOrbit = 'auto auto auto';
            modelViewer.cameraTarget = 'auto auto auto';
        });

        document.getElementById('file-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) modelViewer.src = URL.createObjectURL(file);
        });
    </script>
</body>
</html>