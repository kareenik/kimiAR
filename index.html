<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Variant Explorer</title>
    <!-- Import the model-viewer component -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --viewer-bg: #f3f4f6;
            --sofa-black: #111111;
            --unit: 14px; /* Scaled down for UI grid */
            --gap: 2px;
        }
        body {
            margin: 0;
            background-color: var(--viewer-bg);
            font-family: system-ui, -apple-system, sans-serif;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: var(--viewer-bg);
            --poster-color: transparent;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        /* Custom Scrollbar for the grid */
        .layout-grid::-webkit-scrollbar {
            width: 4px;
        }
        .layout-grid::-webkit-scrollbar-track {
            background: transparent;
        }
        .layout-grid::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        
        #progress-bar {
            width: 0%;
            height: 4px;
            background-color: #3b82f6;
            transition: width 0.3s;
        }
        #progress-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: none;
            z-index: 50;
        }
        model-viewer[loading] #progress-container {
            display: block;
        }

        /* Atomic Silhouette Modules */
        .sofa-module {
            background-color: var(--sofa-black);
            border-radius: 4px; /* Scaled radius */
        }
        
        /* Silhouette Composition Grid */
        .icon-canvas {
            display: grid;
            grid-gap: var(--gap);
            justify-content: center;
            align-content: center;
            padding: 4px;
        }

        .active-layout {
            outline: 2px solid #4f46e5 !important;
            background-color: #eef2ff !important;
        }
    </style>
</head>
<body class="overflow-hidden">

    <!-- The Viewer -->
    <model-viewer 
        id="viewer" 
        camera-controls 
        touch-action="pan-y" 
        src="https://modelviewer.dev/shared-assets/models/glTF-Sample-Assets/Models/MaterialsVariantsShoe/glTF-Binary/MaterialsVariantsShoe.glb" 
        ar 
        ar-modes="webxr scene-viewer quick-look"
        shadow-intensity="1" 
        exposure="1"
        environment-image="neutral"
        max-camera-orbit="auto 90deg auto"
        alt="A 3D model with material variants">
        
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <!-- UI Controls Overlay -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-md px-4 pb-safe">
            <div class="glass-panel rounded-2xl p-5 flex flex-col gap-4 max-h-[60vh] overflow-y-auto">
                
                <!-- Header & Upload -->
                <div class="flex items-center justify-between sticky top-0 bg-white/0 z-10">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">Sofa Configurator</h1>
                        <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Modular System</p>
                    </div>
                    <div class="flex gap-2">
                         <label for="file-upload" class="cursor-pointer px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold rounded uppercase transition-colors shadow-sm flex items-center gap-1">
                            <i data-lucide="upload" class="w-3 h-3"></i> Upload
                        </label>
                        <input id="file-upload" type="file" accept=".gltf,.glb" class="hidden">
                    </div>
                </div>

                <!-- Layouts Accordion -->
                <div class="border-b border-gray-200/50 pb-3">
                    <button id="layout-accordion-btn" class="w-full flex items-center justify-between text-left group">
                        <span class="text-sm font-medium text-gray-700 flex items-center gap-2">
                            <i data-lucide="layout-grid" class="w-4 h-4 text-gray-400"></i>
                            Select Layout
                        </span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transition-transform duration-200 group-hover:text-gray-600" id="layout-chevron"></i>
                    </button>
                    
                    <div id="layout-content" class="mt-3">
                        <div class="grid grid-cols-4 gap-2 layout-grid max-h-56 overflow-y-auto p-1">
                            <!-- Generated via JS -->
                        </div>
                    </div>
                </div>

                <!-- Fabric Selection -->
                <div class="space-y-2">
                    <label for="variant-select" class="text-sm font-medium text-gray-700 flex items-center gap-2">
                        <i data-lucide="palette" class="w-4 h-4 text-gray-400"></i>
                        Select Fabric
                    </label>
                    <div class="relative">
                        <select id="variant-select" class="w-full bg-white/50 border border-gray-200 rounded-lg py-2.5 pl-4 pr-10 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all text-gray-800 text-sm">
                            <option value="default">Default Fabric</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-between items-center pt-1">
                    <button id="reset-view" class="text-xs font-semibold text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1">
                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset View
                    </button>
                    <span id="status-text" class="text-[10px] text-gray-400 italic">Ready</span>
                </div>
            </div>
        </div>
    </model-viewer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        const modelViewer = document.querySelector("#viewer");
        const select = document.querySelector('#variant-select');
        const progressBar = document.querySelector('#progress-bar');
        const statusText = document.querySelector('#status-text');
        const resetBtn = document.querySelector('#reset-view');
        const fileInput = document.querySelector('#file-upload');
        
        // Layout Accordion Logic
        const layoutBtn = document.getElementById('layout-accordion-btn');
        const layoutContent = document.getElementById('layout-content');
        const layoutChevron = document.getElementById('layout-chevron');
        const layoutGrid = document.querySelector('.layout-grid');

        /**
         * Definition of Modular Layouts based on Atomic Blocks
         * D = Seat (1x1)
         * 2D = Double Seat (2x1)
         * SDL = Long Seat (3x1)
         * CL = Chaise Left
         * SDR = Chaise Right
         * CR = Corner Right
         * P1 = Pouf
         */
        const layoutDefinitions = [
            { id: 'S1', label: 'Single', modules: [{ type: 'D', x: 0, y: 0, w: 1, h: 1 }] },
            { id: 'S2', label: 'Double', modules: [{ type: '2D', x: 0, y: 0, w: 2, h: 1 }] },
            { id: 'S3', label: 'Triple', modules: [{ type: 'SDL', x: 0, y: 0, w: 3, h: 1 }] },
            { id: 'L-Left', label: 'L-Left', modules: [
                { type: 'SDL', x: 1, y: 0, w: 3, h: 1 },
                { type: 'CL', x: 0, y: 0, w: 1, h: 2 }
            ]},
            { id: 'L-Right', label: 'L-Right', modules: [
                { type: 'SDL', x: 0, y: 0, w: 3, h: 1 },
                { type: 'SDR', x: 3, y: 0, w: 1, h: 2 }
            ]},
            { id: 'U-Shape', label: 'U-Shape', modules: [
                { type: 'CR', x: 0, y: 0, w: 1, h: 2 },
                { type: 'SDL', x: 1, y: 0, w: 3, h: 1 },
                { type: 'CR', x: 4, y: 0, w: 1, h: 2 }
            ]},
            { id: 'Chaise-D', label: 'Double Chaise', modules: [
                { type: 'CL', x: 0, y: 0, w: 1, h: 2 },
                { type: 'D', x: 1, y: 0, w: 1, h: 1 },
                { type: 'SDR', x: 2, y: 0, w: 1, h: 2 }
            ]},
            { id: 'Corner-L', label: 'Corner L', modules: [
                { type: '2D', x: 0, y: 1, w: 2, h: 1 },
                { type: 'CR', x: 2, y: 0, w: 1, h: 2 }
            ]},
            { id: 'Pouf-Set', label: 'Pouf Set', modules: [
                { type: '2D', x: 0, y: 0, w: 2, h: 1 },
                { type: 'P1', x: 0.5, y: 1.2, w: 0.8, h: 0.8 }
            ]},
            { id: 'S4', label: 'Quad', modules: [{ type: '2D', x: 0, y: 0, w: 2, h: 1 }, { type: '2D', x: 2, y: 0, w: 2, h: 1 }] },
            { id: 'Table-L', label: 'Coffee Set', modules: [
                { type: 'SDL', x: 0, y: 0, w: 3, h: 1 },
                { type: 'P1', x: 1, y: 1.5, w: 1, h: 0.6 }
            ]},
            { id: 'Compact', label: 'Compact', modules: [
                { type: 'D', x: 0, y: 0, w: 1, h: 1 },
                { type: 'D', x: 1.2, y: 0, w: 1, h: 1 }
            ]}
        ];

        function createSofaIcon(definition) {
            const container = document.createElement('div');
            container.className = 'icon-canvas w-full h-full';
            
            // Set dynamic grid based on bounds
            const maxX = Math.max(...definition.modules.map(m => m.x + m.w));
            const maxY = Math.max(...definition.modules.map(m => m.y + m.h));
            
            container.style.gridTemplateColumns = `repeat(${Math.ceil(maxX * 2)}, calc(var(--unit)/2))`;
            container.style.gridTemplateRows = `repeat(${Math.ceil(maxY * 2)}, calc(var(--unit)/2))`;

            definition.modules.forEach(m => {
                const block = document.createElement('div');
                block.className = 'sofa-module';
                block.style.gridColumn = `${Math.round(m.x * 2) + 1} / span ${Math.round(m.w * 2)}`;
                block.style.gridRow = `${Math.round(m.y * 2) + 1} / span ${Math.round(m.h * 2)}`;
                
                // Add specific styling for "Corner" types if needed
                if(m.type.includes('P1')) block.style.borderRadius = '50%';
                
                container.appendChild(block);
            });

            return container;
        }

        // Generate the 12 layout icons
        layoutDefinitions.forEach((layout, index) => {
            const btn = document.createElement('button');
            btn.className = `aspect-square rounded-xl border border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all flex flex-col items-center justify-center p-2 group focus:outline-none ${index === 3 ? 'active-layout' : 'bg-white/60'}`;
            
            const icon = createSofaIcon(layout);
            btn.appendChild(icon);
            
            const label = document.createElement('span');
            label.className = 'text-[9px] text-gray-500 font-bold mt-1 uppercase tracking-tighter';
            label.textContent = layout.label;
            btn.appendChild(label);
            
            btn.addEventListener('click', () => {
                document.querySelectorAll('.layout-grid button').forEach(b => b.classList.remove('active-layout'));
                btn.classList.add('active-layout');
                statusText.textContent = `Selected: ${layout.id}`;
            });
            
            layoutGrid.appendChild(btn);
        });

        layoutBtn.addEventListener('click', () => {
            layoutContent.classList.toggle('hidden');
            layoutChevron.style.transform = layoutContent.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        });

        // --- Standard Viewer Logic ---

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                modelViewer.src = url;
                statusText.textContent = `Loading: ${file.name}`;
            }
        });

        modelViewer.addEventListener('progress', (event) => {
            const progress = event.detail.totalProgress * 100;
            progressBar.style.width = `${progress}%`;
            statusText.textContent = progress < 100 ? `Loading: ${Math.round(progress)}%` : 'Ready';
        });

        modelViewer.addEventListener('load', () => {
            const names = modelViewer.availableVariants;
            select.innerHTML = '<option value="default">Default Fabric</option>';
            
            if (names && names.length > 0) {
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
                statusText.textContent = `${names.length} fabrics available`;
            } else {
                statusText.textContent = 'No variants found';
            }
        });

        select.addEventListener('input', (event) => {
            const variantName = event.target.value === 'default' ? null : event.target.value;
            modelViewer.variantName = variantName;
        });

        resetBtn.addEventListener('click', () => {
            modelViewer.cameraOrbit = '0deg 75deg 105%';
            modelViewer.cameraTarget = 'auto auto auto';
        });

        modelViewer.addEventListener('error', (error) => {
            statusText.textContent = 'Error loading model';
            statusText.classList.add('text-red-500');
            console.error(error);
        });
    </script>
</body>
</html>